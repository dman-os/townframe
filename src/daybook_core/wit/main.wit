package townframe:daybook;

interface types {
    type heads = list<string>;
}

interface drawer {
    use townframe:daybook-types/doc.{doc, doc-patch, facet-raw, doc-id};
    use types.{heads};

    variant get-doc-error {
        doc-not-found,
        invalid-heads(string),
    }
    
    variant update-doc-error {
        doc-not-found,
        branch-not-found,
        invalid-key(string),
        invalid-heads(string),
        invalid-patch(string),
    }
    
    get-doc-at-heads: func(
        doc-id: doc-id,
        heads: heads,
    ) -> result<doc, get-doc-error>;
    
    update-doc-at-heads: func(
        branch-name: string,
        heads: option<heads>,
        patch: doc-patch,
    ) -> result<_, update-doc-error>;
}

interface capabilities {
    use townframe:daybook-types/doc.{doc, doc-patch, facet-raw, doc-id};
    use types.{heads};

    variant update-doc-error {
        invalid-patch(string),
        invalid-key(string),
        other(string),
    }

    resource doc-token-ro {
        get: func() -> doc;
    }

    resource doc-token-rw {
        get: func() -> doc;
        update: func(patch: doc-patch) -> result<_, update-doc-error>;
    }

    resource facet-token-ro {
        exists: func() -> bool;
        get: func() -> facet-raw;
        heads: func() -> heads;
    }

    resource facet-token-rw {
        exists: func() -> bool;
        get: func() -> facet-raw;
        heads: func() -> heads;
        update: func(patch: facet-raw) -> result<_, update-doc-error>;
    }
}

interface facet-routine {
    use townframe:daybook-types/doc.{doc-id};
    use types.{heads};
    use capabilities.{facet-token-ro, facet-token-rw};
    use sqlite-connection.{connection as sqlite-connection-token};

    record facet-routine-args {
        doc-id: doc-id,
        heads: heads,
        facet-key: string,

        rw-facet-tokens: list<tuple<string, facet-token-rw>>,
        ro-facet-tokens: list<tuple<string, facet-token-ro>>,
        rw-config-facet-tokens: list<tuple<string, facet-token-rw>>,
        ro-config-facet-tokens: list<tuple<string, facet-token-ro>>,
        sqlite-connections: list<tuple<string, sqlite-connection-token>>,
    }

    /// Aquire args for facet-routine-args.
    /// If the running instance isn't reconginzed to be a routine,
    /// a trap is raised to the host.
    get-args: func() -> facet-routine-args;
}

// FIXME: rename to local-state-sqlite
interface sqlite-connection {
    use townframe:sql/types.{sql-value, result-row, query-error};

    resource connection {
        query: func(query: string, params: list<sql-value>) -> result<list<result-row>, query-error>;
        query-batch: func(query: string) -> result<_, query-error>;
        sqlite-file-path: func() -> string;
    }
}

interface mltools-ocr {
    use capabilities.{facet-token-ro};
    use townframe:mltools/ocr.{ocr-result};

    ocr-image: func(blob-facet: facet-token-ro) -> result<ocr-result, string>;
}

interface mltools-embed {
    use capabilities.{facet-token-ro};
    use townframe:mltools/embed.{embed-result};

    embed-text: func(text: string) -> result<embed-result, string>;
    embed-image: func(blob-facet: facet-token-ro) -> result<embed-result, string>;
}

interface mltools-image-tools {
    use capabilities.{facet-token-ro};

    record image-bytes-result {
        bytes: list<u8>,
        mime: string,
        width: u32,
        height: u32,
    }

    downsize-image-from-blob: func(
        blob-facet: facet-token-ro,
        max-side: u32,
        jpeg-quality: u8,
    ) -> result<image-bytes-result, string>;
}

interface mltools-llm-chat {
    llm-chat: func(text: string) -> result<string, string>;
    llm-chat-multimodal: func(
        prompt: string,
        image-bytes: list<u8>,
        image-mime: string,
    ) -> result<string, string>;
}

world all-guest {
    import drawer;
    import capabilities;
    import facet-routine;
    import sqlite-connection;
    import mltools-ocr;
    import mltools-embed;
    import mltools-image-tools;
    import mltools-llm-chat;
    import wasi:filesystem/preopens@0.2.6;
}
